/**
 * SubclassService - v0.1.0 - 2015-10-07
 * https://github.com/msdoom2011/subclass-service
 *
 * Copyright (c) 2015 Dmitry Osipishin | msdoom2011@gmail.com
 */
!function(){"use strict";Subclass.Service={},Subclass.Service.Error={},Subclass.Service.Extension={},Subclass.Service.ServiceManager=function(){function a(a){a&&a instanceof Subclass.Module||Subclass.Error.create("InvalidArgument").argument("the instance of module",!1).received(a).expected("an instance of Subclass.Module").apply(),this._module=a,this._parameters={},this._services={}}return a.prototype.initialize=function(){var a=this.getModule().getEventManager(),b=this;a.getEvent("onLoadingEnd").addListener(function(){var a=b.getModule();if(a.isRoot()){var c=a.getServiceManager();c.register("module"),c.register("service_container"),c.register("parameter_container")}}),a.getEvent("onReadyBefore").addListener(function(){b.getModule().isRoot()&&b.normalize()}),a.getEvent("onAddPlugin").addListener(function(a){b.normalize()})},a.prototype.getModule=function(){return this._module},a.prototype.normalize=function(){var a=this.getServices();for(var b in a)if(a.hasOwnProperty(b)){var c=a[b].getExtends(),d=a[b].getDefinition();if(c){var e=this.get(c),f=Subclass.Tools.copy(e.getDefinition());d["abstract"]||(d["abstract"]=!1),d=Subclass.Tools.extend(f,d),a[b].setDefinition(d)}}},a.prototype.getServices=function(a,b){var c=this.getModule(),d=c.getModuleStorage(),e={},f=this;return a!==!0&&(a=!1),b!==!1&&(b=!0),a||!b||c.isRoot()||arguments[2]==c?a?this._services:(d.eachModule(function(a){if(a==c)return void Subclass.Tools.extend(e,f.getServices(!0,!1));var b=a.getServiceManager(),d=b.getServices(!1,!1);Subclass.Tools.extend(e,d)}),e):c.getRoot().getServiceManager().getServices(!1,!1,c)},a.prototype.findByTag=function(a){var b=this.getServices(),c=[];for(var d in b)if(b.hasOwnProperty(d)){var e=b[d],f=e.getTags();f.indexOf(a)>=0&&!e.getAbstract()&&c.push(e)}return c},a.prototype.findLocations=function(a){var b=this.getModule().getRoot(),c=[];arguments[1]&&(b=arguments[1]);var d=b.getModuleStorage();return d.eachModule(function(d){var e=d.getServiceManager();if(e.isset(a,!0)&&c.push(d.getName()),d!=b&&d.hasPlugins())for(var f=d.getModuleStorage(),g=f.getPlugins(),h=0;h<g.length;h++){var i=g[h],j=i.getServiceManager(),k=j.findLocations(a,i);c=c.concat(k)}}),c},a.prototype.rename=function(a,b){this.isset(a)||Subclass.Error.create('Trying to rename non existent service "'+a+'".'),b&&"string"==typeof b||Subclass.Error.create("InvalidError").argument("the new service name",!1).expected("a string").received(b).apply();for(var c=this.findLocations(a),d=0;d<c.length;d++){var e=Subclass.getModule(c[d]),f=e.getServiceManager(),g=f.getServices(!0),h=g[a];h||Subclass.Error.create('The work of method "Subclass.Service.ServiceManager#findLocations" is incorrect.'),delete g[a],g[b]=h,h.setName(b)}},a.prototype.register=function(a,b){this.getModule().isReady()&&Subclass.Error.create("Can't define new services when module is ready."),b||(b={});var c=Subclass.Tools.createClassInstance(Subclass.Service.Service,this,a,b);this._services[a]=c;var d=this.getModule(),e=d.getClassManager();if(Subclass.Tools.isEmpty(b)&&c.initialize(),b.className){var f=c.getClassName();e.load(f)}return c},a.prototype.get=function(a){return this.isset(a)||Subclass.Error.create('Service with name "'+a+'" is not exists.'),this.getServices()[a]},a.prototype.isset=function(a,b){return!!this.getServices(b)[a]},a}(),Subclass.Service.Error.AbstractServiceError=function(){function a(b){a.$parent.call(this,b)}return a.$parent=Subclass.Error.ErrorBase,a.$mixins=[Subclass.Error.Option.Service],a.getName=function(){return"AbstractService"},a.getRequiredOptions=function(){var b=a.$parent.getRequiredOptions();return b.concat(["service"])},a.prototype.buildMessage=function(){var b=a.$parent.prototype.buildMessage.call(this);return b||(b+="You can't get/create instance of abstract service \""+this.service()+'".'),b},Subclass.Error.registerType(a.getName(),a),a}(),Subclass.Service.Error.InvalidServiceOptionError=function(){function a(b){a.$parent.call(this,b)}return a.$parent=Subclass.Error.ErrorBase,a.$mixins=[Subclass.Error.Option.Service,Subclass.Error.Option.Option,Subclass.Error.Option.Expected,Subclass.Error.Option.Received],a.getName=function(){return"InvalidServiceOption"},a.getRequiredOptions=function(){var b=a.$parent.getRequiredOptions();return b.concat(["service","option"])},a.prototype.buildMessage=function(){var b=a.$parent.prototype.buildMessage.call(this);return b||(b+='Invalid value of option "'+this.option()+'" ',b+='in definition of service "'+this.service()+'". ',b+=this.hasExpected()?"It must be "+this.expected()+". ":"",b+=this.hasReceived()?this.received():""),b},Subclass.Error.registerType(a.getName(),a),a}(),Subclass.Error.Option.Service=function(){function a(){return{_service:void 0}}return a.prototype.service=function(a){if(!arguments.length)return this._service;if(a&&"string"!=typeof a)throw new Error("Specified invalid service name. It must be a string.");return this._service=a,this},a.prototype.hasService=function(){return void 0!==this._service},a}(),Subclass.Service.Error.ServiceInitializedError=function(){function a(b){a.$parent.call(this,b)}return a.$parent=Subclass.Error.ErrorBase,a.$mixins=[Subclass.Error.Option.Service],a.getName=function(){return"ServiceInitialized"},a.getRequiredOptions=function(){var b=a.$parent.getRequiredOptions();return b.concat(["service"])},a.prototype.buildMessage=function(){var b=a.$parent.prototype.buildMessage.call(this);return b||(b+="You can't modify definition of the service \""+this.service()+'" after it was created.'),b},Subclass.Error.registerType(a.getName(),a),a}(),Subclass.Service.Extension.ModuleAPIExtension=function(){function a(b){a.$parent.apply(this,arguments)}a.$parent=Subclass.Extension;var b=Subclass.ModuleAPI;return b.prototype.getServiceManager=function(){return this.getModule().getServiceManager.apply(this.getModule(),arguments)},b.prototype.registerService=function(){return this.getModule().getServiceManager().register.apply(this.getModule().getServiceManager(),arguments)},b.prototype.registerServices=function(){return this.getModule().getSettingsManager().setServices.apply(this.getModule().getSettingsManager(),arguments)},b.prototype.getService=function(){return this.getModule().getServiceManager().get.apply(this.getModule().getServiceManager(),arguments)},b.prototype.issetService=function(){return this.getModule().getServiceManager().isset.apply(this.getModule().getServiceManager(),arguments)},Subclass.Module.onInitializeBefore(function(c,d){b=Subclass.Tools.buildClassConstructor(b),b.hasExtension(a)||b.registerExtension(a)}),a}(),Subclass.Service.Extension.ModuleExtension=function(){function a(b){a.$parent.apply(this,arguments)}a.$parent=Subclass.Extension,a.initialize=function(a){this.$parent.initialize.apply(this,arguments);var b=a.getEventManager();b.getEvent("onInitialize").addListener(function(a,b){this._serviceManager=Subclass.Tools.createClassInstance(Subclass.Service.ServiceManager,this)}),b.getEvent("onInitializeAfter").addListener(function(a,b){this.getServiceManager().initialize()})};var b=Subclass.Module;return b.prototype.getServiceManager=function(){return this._serviceManager},Subclass.Module.onInitializeBefore(function(c,d){b.hasExtension(a)||b.registerExtension(a)}),a}(),Subclass.Service.Extension.ModuleInstanceExtension=function(){function a(b){a.$parent.apply(this,arguments)}a.$parent=Subclass.Extension,a.initialize=function(b){a.$parent.initialize.apply(this,arguments),b.getEvent("onInitialize").addListener(function(){this._serviceContainer=Subclass.Tools.createClassInstance(Subclass.Service.ServiceContainer,this)})};var b=Subclass.ModuleInstance;return b.prototype.getServiceContainer=function(){return this._serviceContainer},Subclass.Module.onInitializeBefore(function(c,d){b=Subclass.Tools.buildClassConstructor(b),b.hasExtension(a)||b.registerExtension(a)}),a}(),Subclass.Service.Extension.SettingsManagerExtension=function(){function a(b){a.$parent.apply(this,arguments)}a.$parent=Subclass.Extension;var b=Subclass.SettingsManager;return b.prototype.setServices=function(a){this.checkModuleIsReady(),a&&Subclass.Tools.isPlainObject(a)||Subclass.Error.create("InvalidModuleOption").option("services").module(this.getModule().getName()).received(a).expected("a plain object").apply();var b=this.getModule().getServiceManager();for(var c in a)a.hasOwnProperty(c)&&b.register(c,a[c])},b.prototype.getServices=function(){for(var a=this.getModule().getServiceManager().getServices(),b={},c=0;c<a.length;c++){var d=a[c].getDefinition(),e=a[c].getName();b[e]=Subclass.Tools.copy(d)}return b},Subclass.Module.onInitializeBefore(function(c,d){b=Subclass.Tools.buildClassConstructor(b),b.hasExtension(a)||b.registerExtension(a)}),a}(),Subclass.ClassManager.register("Interface","Subclass/Service/TaggableInterface",{processTaggedServices:function(a){}}),Subclass.Parser.ServiceParser=function(){function a(){a.$parent.apply(this,arguments)}return a.$parent=Subclass.Parser.ParserAbstract,a.getName=function(){return"service"},a.prototype={parse:function(a){var b,c=this.getParserManager(),d=c.getModuleInstance(),e=d.getServiceContainer();return"string"==typeof a&&(b=a.match(/^@([a-z_\.0-9]+)$/i))?(b=this.getParserManager().parse(b[1]),e.get(b)):a}},Subclass.Parser.ParserManager.registerParser(a),a}(),Subclass.Service.Service=function(){function a(a,b,c){a&&a instanceof Subclass.Service.ServiceManager||Subclass.Error.create("InvalidArgument").argument("the service manager",!1).received(a).expected('instance of "Subclass.Service.ServiceManager" class').apply(),this._serviceManager=a,this._name=null,this._definition=this.setDefinition(c),this._instance=null,this._initialized=!1,this.setName(b)}return a.prototype.getServiceManager=function(){return this._serviceManager},a.prototype.setName=function(a){var b=/^[0-9_\.a-z]+$/i;a&&"string"==typeof a&&a.match(b)||Subclass.Error.create("InvalidArgument").argument("the name of service",!1).expected("a string and should match regular expression "+b).received(a).apply(),this._name=a},a.prototype.getName=function(){return this._name},a.prototype.setDefinition=function(a){return a&&Subclass.Tools.isPlainObject(a)||Subclass.Error.create("InvalidArgument").argument("the definition of service",!1).received(a).expected("a plain object").apply(),this._definition=a,a},a.prototype.getDefinition=function(){return this._definition},a.prototype.initialize=function(){this.isInitialized()||(this.validateDefinition(),this.processDefinition())},a.prototype.rename=function(a){this.getServiceManager().rename(this.getName(),a)},a.prototype.isInitialized=function(){return this._initialized},a.prototype.validateAbstract=function(a){return"boolean"!=typeof a&&Subclass.Error.create("InvalidServiceOption").option("abstract").service(this.getName()).received(a).expected("a boolean").apply(),!0},a.prototype.setAbstract=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateAbstract(a),this.getDefinition()["abstract"]=a},a.prototype.getAbstract=function(){return this.getDefinition()["abstract"]},a.prototype.validateExtends=function(a){return"string"!=typeof a&&Subclass.Error.create("InvalidServiceOption").option("extends").service(this.getName()).received(a).expected("a string").apply(),!0},a.prototype.setExtends=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateExtends(a),this.getDefinition()["extends"]=a},a.prototype.getExtends=function(){return this.getDefinition()["extends"]},a.prototype.validateClassName=function(a){return"string"!=typeof a&&Subclass.Error.create("InvalidServiceOption").option("className").service(this.getName()).received(a).expected("a string").apply(),!0},a.prototype.setClassName=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateClassName(a),this.getDefinition().className=a},a.prototype.getClassName=function(){return this.normalizeClassName(this.getDefinition().className)},a.prototype.normalizeClassName=function(a){var b=/%([^%]+)%/i;if(b.test(a)){var c=this.getServiceManager().getModule().getParameterManager(),d=a.match(b)[1],e=c.get(d);a=a.replace(b,e)}return a},a.prototype.validateArguments=function(a){return null===a||Array.isArray(a)||Subclass.Error.create("InvalidServiceOption").option("arguments").service(this.getName()).received(a).expected("an array").apply(),!0},a.prototype.setArguments=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateArguments(a),this.getDefinition().arguments=a},a.prototype.addArgument=function(a,b){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),"number"!=typeof a&&Subclass.Error.create("InvalidArgument").argument("the index of new service constructor argument",!1).expect("a number").received(a).apply(),this.getDefinition().arguments[a]=b},a.prototype.normalizeArguments=function(a,b){if(!a)return[];a=Subclass.Tools.extend([],a);for(var c=0;c<a.length;c++)a[c]=b.parse(a[c]);return a},a.prototype.getArguments=function(){return this.getDefinition().arguments||[]},a.prototype.validateCalls=function(a){try{if(!a&&null!==a||a&&"object"!=typeof a)throw"error";if(a)for(var b in a)if(a.hasOwnProperty(b)&&!Array.isArray(a[b]))throw"error"}catch(c){if("error"!=c)throw c;Subclass.Error.create("InvalidServiceOption").option("calls").service(this.getName()).received(a).expected("a plain object with array properties").apply()}return!0},a.prototype.setCalls=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateCalls(a),this.getDefinition().calls=a},a.prototype.addCall=function(a,b){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),a&&"string"==typeof a||Subclass.Error.create("InvalidArgument").argument("the name of callable method",!1).expected("a string").received(a).apply(),arguments.length>1&&!Array.isArray(b)&&Subclass.Error.create("InvalidArgument").argument("the methods arguments",!1).expected("an array").received(b).apply(),b||(b=[]),this.getDefinition().calls[a]=b},a.prototype.normalizeCalls=function(a,b){if(!a)return{};if(a=Subclass.Tools.extend({},a))for(var c in a)a.hasOwnProperty(c)&&(a[c]=this.normalizeArguments(a[c],b));return a},a.prototype.getCalls=function(){return this.getDefinition().calls||{}},a.prototype.validateSingleton=function(a){return null!==a&&"boolean"!=typeof a&&Subclass.Error.create("InvalidServiceOption").option("singleton").service(this.getName()).received(a).expected("a boolean").apply(),!0},a.prototype.setSingleton=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateSingleton(a),this.getDefinition().singleton=a},a.prototype.getSingleton=a.prototype.isSingleton=function(){return this.getDefinition().singleton},a.prototype.validateTags=function(a){return null===a||Array.isArray(a)||Subclass.Error.create("InvalidServiceOption").option("tags").service(this.getName()).received(a).expected("an array of strings").apply(),!0},a.prototype.setTags=function(a){this.isInitialized()&&Subclass.Error.create("ServiceInitialized").service(this.getName()).apply(),this.validateTags(a),this.getDefinition().tags=a},a.prototype.getTags=function(){return this.getDefinition().tags||[]},a.prototype.getBaseDefinition=function(){return{"abstract":!1,"extends":null,className:null,arguments:[],calls:{},singleton:!0,tags:[]}},a.prototype.validateDefinition=function(){function a(a,d){if("string"==typeof a&&a.match(/^@[a-z_0-9]+$/i)){var e=a.substr(1),h=b.get(e);(!h.isSingleton()&&c.indexOf(e)>=0||"calls"!=d&&!h.isSingleton()&&e==f[0]||"arguments"==d&&e==f[0])&&Subclass.Error.create("Can't create instance of service \""+g.getName()+'". Circular dependency injection was found.'),f.indexOf(e)<=0&&f.concat(h.validateDefinition(f))}}var b=this.getServiceManager(),c=this.getTags(),d=this.getArguments(),e=this.getCalls(),f=[this.getName()],g=this;arguments[0]&&Array.isArray(f)&&(f=arguments[0]);var h=this.getClassName();if(h){var i=b.getModule().getClassManager(),j=i.get(h).getDefinition();for(l in e)e.hasOwnProperty(l)&&(j.getData().hasOwnProperty(l)||Subclass.Error.create('Specified invalid "calls" option in the service "'+this.getName()+'". The method "'+l+'" does not exist in class "'+h+'".'))}for(var k=0;k<d.length;k++)a(d[k],"arguments");for(var l in e)if(e.hasOwnProperty(l))for(k=0;k<e[l].length;k++)a(e[l][k],"calls");return f},a.prototype.processDefinition=function(){var a=this.getDefinition();this._definition=this.getBaseDefinition();for(var b in a)if(a.hasOwnProperty(b)){var c="set"+b[0].toUpperCase()+b.substr(1);this[c]&&this[c](a[b])}this._initialized=!0},a}(),Subclass.Service.ServiceContainer=function(){function a(a){a&&a instanceof Subclass.ModuleInstance||Subclass.Error.create("InvalidArgument").argument("the module instance",!1).expected('an instance of class "Subclass.ModuleInstance"').received(a).apply(),this._moduleInstance=a,this._module=a.getModule(),this._serviceFactory=Subclass.Tools.createClassInstance(Subclass.Service.ServiceFactory,this),this._services={},this._events=[],this._initialized=!1,this.registerEvent("onInitialize"),this.initialize()}return a.$parent=Subclass.Extendable,a.$mixins=[Subclass.Event.EventableMixin],a.prototype={initialize:function(){this.isInitialized()&&Subclass.Error.create("Service container is already initialized!"),Subclass.Tools.extend(this._services,{module:this._module,service_container:this,parameter_container:this._moduleInstance.getParameterContainer()}),this.initializeExtensions(),this.getEvent("onInitialize").trigger(),this._initialized=!0},isInitialized:function(){return this._initialized},getModule:function(){return this._module},getModuleInstance:function(){return this._moduleInstance},getServiceManager:function(){return this.getModule().getServiceManager()},setServiceInstance:function(a,b){this.isServiceCreated(a)&&Subclass.Error.create('Trying to replace already created instance of service "'+a+'"'),this._services[a]=b},getServiceInstance:function(a){return this.isServiceCreated(a)?this._services[a]:null},isServiceCreated:function(a){return this._services.hasOwnProperty(a)},getServices:function(){return this.getServiceManager().getServices()},get:function(a){if(this.isServiceCreated(a))return this.getServiceInstance(a);var b=this.getServiceManager().get(a),c=this._serviceFactory.createService(b);b.isSingleton()&&this.setServiceInstance(a,c);var d=this.getModuleInstance().getParser(),e=b.normalizeCalls(b.getCalls(),d);for(var f in e)e.hasOwnProperty(f)&&c[f].apply(c,e[f]);if(c.isImplements("Subclass/Service/TaggableInterface")){var g=this.findByTag(b.getName());c.processTaggedServices(g)}return c},isset:function(a){return this.getServiceManager().isset(a)},findByTag:function(a){var b=this.getServiceManager().findByTag(a),c=this;return b.map(function(a,b,d){d[b]=c.get(a.getName())}),b}},a}(),Subclass.Service.ServiceFactory=function(){function a(a){a&&a instanceof Subclass.Service.ServiceContainer||Subclass.Error.create("InvalidArgument").argument("the service manager instance",!1).expected("an instance of Subclass.Service.ServiceManager").received(a).apply(),this._serviceContainer=a}return a.prototype.getServiceContainer=function(){return this._serviceContainer},a.prototype.createService=function(a){a.getAbstract()&&Subclass.Error.create("AbstractService").service(a.getName()).apply();var b=this.getServiceContainer(),c=b.getModuleInstance(),d=c.getParser(),e=b.getServiceManager(),f=e.getModule().getClassManager();a.initialize();var g=f.get(a.getClassName()),h=a.normalizeArguments(a.getArguments(),d);return g.createInstance.apply(g,h)},a}(),Subclass.registerPlugin(function(){function a(){a.$parent.call(this)}return a.$parent=Subclass.SubclassPlugin,a.getName=function(){return"SubclassService"},a.getDependencies=function(){return["SubclassParser","SubclassInstance","SubclassParameter"]},a}())}();